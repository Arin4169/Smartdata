import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import re
from collections import Counter
from wordcloud import WordCloud
import matplotlib.font_manager as fm
from konlpy.tag import Okt
import platform
import os
from utils import (
    generate_wordcloud_data, 
    create_wordcloud, 
    simple_sentiment_analysis, 
    analyze_options,
    get_font_path,
    get_stopwords,
    add_stopword,
    reset_stopwords,
    remove_stopword,
    DEFAULT_STOPWORDS
)

# í•œê¸€ í°íŠ¸ ì„¤ì •
korean_font_path = get_font_path()
if korean_font_path:
    plt.rcParams['font.family'] = fm.FontProperties(fname=korean_font_path).get_name()
else:
    # í°íŠ¸ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš° ì‹œìŠ¤í…œ ë‚´ì¥ í°íŠ¸ ì‚¬ìš© ì‹œë„
    try:
        # Windows
        if platform.system() == 'Windows':
            plt.rcParams['font.family'] = 'Malgun Gothic'
        # macOS
        elif platform.system() == 'Darwin':
            plt.rcParams['font.family'] = 'AppleGothic'
        # Linux
        else:
            plt.rcParams['font.family'] = 'NanumGothic'
    except:
        st.warning("í•œê¸€ í°íŠ¸ë¥¼ ì„¤ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹œê°í™”ì—ì„œ í•œê¸€ì´ ì œëŒ€ë¡œ í‘œì‹œë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

plt.rcParams['axes.unicode_minus'] = False

# í˜ì´ì§€ ê¸°ë³¸ ì„¤ì •
st.set_page_config(
    page_title="ìŠ¤ë§ˆíŠ¸ ìŠ¤í† ì–´ ë°ì´í„° ë¶„ì„",
    page_icon="ğŸ“Š",
    layout="wide"
)

# ì œëª© í‘œì‹œ
st.title("ë„¤ì´ë²„ ìŠ¤ë§ˆíŠ¸ ìŠ¤í† ì–´ ë°ì´í„° ë¶„ì„")

# í•¨ìˆ˜: ë¶ˆìš©ì–´ ê´€ë¦¬ UI ìƒì„±
def render_stopwords_ui():
    """ë¶ˆìš©ì–´ ê´€ë¦¬ UIë¥¼ í‘œì‹œí•©ë‹ˆë‹¤."""
    with st.expander("ì›Œë“œí´ë¼ìš°ë“œ ë¶ˆìš©ì–´ ê´€ë¦¬", expanded=False):
        # í˜„ì¬ ë¶ˆìš©ì–´ ëª©ë¡ í‘œì‹œ
        st.subheader("í˜„ì¬ ë¶ˆìš©ì–´ ëª©ë¡")
        current_stopwords = get_stopwords()
        
        # ë¶ˆìš©ì–´ë¥¼ ì—¬ëŸ¬ ì—´ë¡œ í‘œì‹œ
        cols = st.columns(4)
        for i, word in enumerate(sorted(current_stopwords)):
            with cols[i % 4]:
                if st.button(f"âŒ {word}", key=f"remove_{word}"):
                    remove_stopword(word)
                    st.rerun()
        
        # ìƒˆ ë¶ˆìš©ì–´ ì¶”ê°€
        st.subheader("ë¶ˆìš©ì–´ ì¶”ê°€")
        col1, col2 = st.columns([3, 1])
        
        with col1:
            new_stopword = st.text_input("ì¶”ê°€í•  ë¶ˆìš©ì–´ (ì—¬ëŸ¬ ë‹¨ì–´ëŠ” ê³µë°±ìœ¼ë¡œ êµ¬ë¶„)", key="new_stopword")
        
        with col2:
            if st.button("ì¶”ê°€", key="add_stopword"):
                if new_stopword.strip():
                    add_stopword(new_stopword)
                    st.session_state.new_stopword = ""  # ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                    st.rerun()
        
        # ë¶ˆìš©ì–´ ì´ˆê¸°í™”
        if st.button("ê¸°ë³¸ ë¶ˆìš©ì–´ë¡œ ì´ˆê¸°í™”", key="reset_stopwords"):
            reset_stopwords()
            st.rerun()
        
        st.info("ë¶ˆìš©ì–´ëŠ” ì›Œë“œí´ë¼ìš°ë“œì—ì„œ ì œì™¸ë˜ëŠ” ë‹¨ì–´ì…ë‹ˆë‹¤. ë¶ˆí•„ìš”í•˜ê²Œ ìì£¼ ë“±ì¥í•˜ëŠ” ë‹¨ì–´ë¥¼ ì¶”ê°€í•˜ë©´ ë” ì˜ë¯¸ ìˆëŠ” ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.")

# í•¨ìˆ˜: íŒŒì¼ ìœ í˜• ìë™ ê°ì§€
def detect_file_type(df):
    """ì—…ë¡œë“œëœ íŒŒì¼ì˜ ìœ í˜•ì„ ìë™ìœ¼ë¡œ ê°ì§€í•©ë‹ˆë‹¤"""
    # ë¦¬ë·° íŒŒì¼ ê°ì§€
    potential_review_columns = ['REVIEW_CONTENT', 'review_content', 'ë¦¬ë·°ë‚´ìš©', 'ë‚´ìš©', 'CONTENT']
    if any(col in df.columns for col in potential_review_columns):
        return "review"
    
    # ì˜µì…˜ ë¹„ìœ¨ íŒŒì¼ ê°ì§€
    potential_option_columns = ['OPTION_INFO', 'option_info', 'ì˜µì…˜ì •ë³´', 'ì˜µì…˜ëª…', 'ìƒí’ˆì˜µì…˜']
    potential_count_columns = ['COUNT', 'count', 'ìˆ˜ëŸ‰', 'íŒë§¤ëŸ‰', 'íŒë§¤ìˆ˜ëŸ‰']
    if any(col in df.columns for col in potential_option_columns) and any(col in df.columns for col in potential_count_columns):
        return "option"
    
    # íŒë§¤ í˜„í™© íŒŒì¼ ê°ì§€ (ê¸°íƒ€ íŒŒì¼ì€ íŒë§¤ í˜„í™©ìœ¼ë¡œ ê°„ì£¼)
    return "sales"

# í•¨ìˆ˜: ë¦¬ë·° ë°ì´í„°í”„ë ˆì„ ì»¬ëŸ¼ ì´ë¦„ í™•ì¸ ë° ìˆ˜ì •
def check_review_columns(df):
    """ë¦¬ë·° ë°ì´í„° ì»¬ëŸ¼ ì´ë¦„ í™•ì¸ ë° í‘œì¤€í™”"""
    # ë¦¬ë·° ë‚´ìš©ì„ ë‹´ëŠ” ì»¬ëŸ¼ í™•ì¸
    potential_review_columns = ['REVIEW_CONTENT', 'review_content', 'ë¦¬ë·°ë‚´ìš©', 'ë‚´ìš©', 'CONTENT']
    review_col = None
    
    for col in potential_review_columns:
        if col in df.columns:
            review_col = col
            break
    
    if review_col and review_col != 'review_content':
        df = df.rename(columns={review_col: 'review_content'})
    
    return df

# í•¨ìˆ˜: ì˜µì…˜ ë°ì´í„°í”„ë ˆì„ ì»¬ëŸ¼ ì´ë¦„ í™•ì¸ ë° ìˆ˜ì •
def check_option_columns(df):
    """ì˜µì…˜ ë°ì´í„° ì»¬ëŸ¼ ì´ë¦„ í™•ì¸ ë° í‘œì¤€í™”"""
    # ì˜µì…˜ ì •ë³´ë¥¼ ë‹´ëŠ” ì»¬ëŸ¼ í™•ì¸
    potential_option_columns = ['OPTION_INFO', 'option_info', 'ì˜µì…˜ì •ë³´', 'ì˜µì…˜ëª…', 'ìƒí’ˆì˜µì…˜']
    option_col = None
    
    for col in potential_option_columns:
        if col in df.columns:
            option_col = col
            break
    
    # ìˆ˜ëŸ‰/íŒë§¤ëŸ‰ ì •ë³´ë¥¼ ë‹´ëŠ” ì»¬ëŸ¼ í™•ì¸
    potential_count_columns = ['COUNT', 'count', 'ìˆ˜ëŸ‰', 'íŒë§¤ëŸ‰', 'íŒë§¤ìˆ˜ëŸ‰']
    count_col = None
    
    for col in potential_count_columns:
        if col in df.columns:
            count_col = col
            break
    
    # ì»¬ëŸ¼ëª… í‘œì¤€í™”
    if option_col and option_col != 'option_info':
        df = df.rename(columns={option_col: 'option_info'})
    
    if count_col and count_col != 'count':
        df = df.rename(columns={count_col: 'count'})
    
    return df

# ì‚¬ì´ë“œë°” - íŒŒì¼ ì—…ë¡œë“œ ë° ë©”ë‰´
with st.sidebar:
    st.header("ë°ì´í„° ì—…ë¡œë“œ")
    uploaded_file = st.file_uploader("ìŠ¤ë§ˆíŠ¸ ìŠ¤í† ì–´ ë°ì´í„° íŒŒì¼", type=["xlsx", "csv"], help="ë¦¬ë·° ë¶„ì„, ì˜µì…˜ ë¹„ìœ¨, íŒë§¤ í˜„í™© ë“±ì˜ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.")
    
    # íŒŒì¼ íƒ€ì… ì„¤ëª…
    with st.expander("íŒŒì¼ íƒ€ì… ì„¤ëª…"):
        st.info("""
        â€¢ ë¦¬ë·° ë¶„ì„ íŒŒì¼: ë¦¬ë·° ë‚´ìš© ì»¬ëŸ¼ì„ í¬í•¨í•œ íŒŒì¼
        â€¢ ì˜µì…˜ ë¹„ìœ¨ íŒŒì¼: ì˜µì…˜ ì •ë³´ì™€ íŒë§¤ëŸ‰/ìˆ˜ëŸ‰ ì»¬ëŸ¼ì„ í¬í•¨í•œ íŒŒì¼
        â€¢ íŒë§¤ í˜„í™© íŒŒì¼: ê¸°íƒ€ íŒë§¤ ê´€ë ¨ íŒŒì¼
        
        íŒŒì¼ ìœ í˜•ì€ ìë™ìœ¼ë¡œ ê°ì§€ë©ë‹ˆë‹¤.
        """)
    
    st.header("ë¶„ì„ ë©”ë‰´")
    analysis_option = st.radio(
        "ë¶„ì„ ìœ í˜• ì„ íƒ",
        ["ë¦¬ë·° ë¶„ì„ - ì›Œë“œí´ë¼ìš°ë“œ", "ë¦¬ë·° ë¶„ì„ - ê°ì •ë¶„ì„", "ì˜µì…˜ ë¶„ì„"]
    )

# ë°ì´í„° ì €ì¥ ë³€ìˆ˜
review_df = None
option_df = None
sales_df = None

# ë©”ì¸ í™”ë©´
if uploaded_file is None:
    st.info("ğŸ‘ˆ ì™¼ìª½ ì‚¬ì´ë“œë°”ì—ì„œ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
    
    # ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš© ì˜µì…˜
    if st.button("ìƒ˜í”Œ ë°ì´í„°ë¡œ ì‹œì‘í•˜ê¸°"):
        try:
            # ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ
            review_df = pd.read_excel("data/reviewcontents (3).xlsx")
            option_df = pd.read_excel("data/ì˜µì…˜ë¹„ìœ¨ (1).xlsx")
            sales_df = pd.read_excel("data/ìŠ¤í† ì–´ì „ì²´íŒë§¤í˜„í™© (1).xlsx")
            
            # ë°ì´í„° ì»¬ëŸ¼ í‘œì¤€í™”
            review_df = check_review_columns(review_df)
            option_df = check_option_columns(option_df)
            
            st.success("ìƒ˜í”Œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!")
            
            # ìƒ˜í”Œ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
            st.subheader("ìƒ˜í”Œ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°")
            
            st.write("ë¦¬ë·° ë°ì´í„°:")
            st.dataframe(review_df.head(3))
            
            st.write("ì˜µì…˜ ë°ì´í„°:")
            st.dataframe(option_df.head(3))
            
            st.write("íŒë§¤ í˜„í™© ë°ì´í„°:")
            st.dataframe(sales_df.head(3))
            
            # ë¶„ì„ ìœ í˜•ì— ë”°ë¥¸ ì²˜ë¦¬
            if analysis_option == "ë¦¬ë·° ë¶„ì„ - ì›Œë“œí´ë¼ìš°ë“œ":
                st.subheader("ì›Œë“œí´ë¼ìš°ë“œ ë¶„ì„")
                
                # ë¶ˆìš©ì–´ ê´€ë¦¬ UI í‘œì‹œ
                render_stopwords_ui()
                
                with st.spinner("ì›Œë“œí´ë¼ìš°ë“œ ìƒì„± ì¤‘..."):
                    word_count, top_words = generate_wordcloud_data(review_df, 'review_content')
                    
                    # ì›Œë“œí´ë¼ìš°ë“œ ìƒì„±
                    if word_count:
                        wc = create_wordcloud(word_count)
                        
                        # ì›Œë“œí´ë¼ìš°ë“œì™€ ìƒìœ„ 20ê°œ ë‹¨ì–´ë¥¼ ì¢Œìš°ë¡œ ë°°ì¹˜
                        col1, col2 = st.columns([1.5, 1])
                        
                        with col1:
                            # ì›Œë“œí´ë¼ìš°ë“œ ì œëª© ì¶”ê°€ (ì¤‘ì•™ ì •ë ¬)
                            st.markdown("<h3 style='text-align: center;'>ì›Œë“œí´ë¼ìš°ë“œ</h3>", unsafe_allow_html=True)
                            
                            # ì›Œë“œí´ë¼ìš°ë“œ í‘œì‹œ
                            fig1, ax = plt.subplots(figsize=(10, 10))
                            ax.imshow(wc, interpolation='bilinear')
                            ax.axis('off')
                            plt.tight_layout(pad=0)
                            st.pyplot(fig1)
                        
                        with col2:
                            # ìƒìœ„ 20ê°œ ë‹¨ì–´ í‘œì‹œ (ì¤‘ì•™ ì •ë ¬)
                            st.markdown("<h3 style='text-align: center;'>ìƒìœ„ 20ê°œ ë‹¨ì–´</h3>", unsafe_allow_html=True)
                            
                            # ìƒìœ„ ë‹¨ì–´ ë§‰ëŒ€ ê·¸ë˜í”„
                            top_words_df = pd.DataFrame({
                                'ë‹¨ì–´': list(top_words.keys()),
                                'ì–¸ê¸‰ íšŸìˆ˜': list(top_words.values())
                            })
                            
                            # ì •í™•íˆ ê°™ì€ í¬ê¸°ë¡œ ê·¸ë˜í”„ ìƒì„±
                            fig2, ax = plt.subplots(figsize=(10, 10))
                            bars = ax.barh(top_words_df['ë‹¨ì–´'], top_words_df['ì–¸ê¸‰ íšŸìˆ˜'], color='steelblue')
                            
                            # ë¦¬ë·° ìˆ˜ í‘œì‹œ
                            for i, bar in enumerate(bars):
                                width = bar.get_width()
                                ax.text(width + width*0.02, bar.get_y() + bar.get_height()/2, 
                                        f'{int(width):,}', 
                                        va='center', fontsize=9)
                            
                            # xì¶• ë²”ìœ„ ì¡°ì • (ì—¬ë°± ì¤„ì´ê¸°)
                            if len(top_words) > 0:
                                max_count = max(top_words.values())
                                plt.xlim(0, max_count * 1.15)  # í…ìŠ¤íŠ¸ ìœ„í•œ ì—¬ìœ  ê³µê°„
                                
                            # ê·¸ë˜í”„ ì œëª© ë° ë ˆì´ì•„ì›ƒ ì¡°ì •
                            plt.title('')
                            plt.tight_layout(pad=0.2)
                            st.pyplot(fig2)
                    else:
                        st.warning("ë¶„ì„í•  ë¦¬ë·° ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            
            elif analysis_option == "ë¦¬ë·° ë¶„ì„ - ê°ì •ë¶„ì„":
                st.subheader("ê°ì • ë¶„ì„")
                
                with st.spinner("ê°ì • ë¶„ì„ ì¤‘..."):
                    # ê°ì • ë¶„ì„ ìˆ˜í–‰
                    df_sentiment, sentiment_counts = simple_sentiment_analysis(review_df, 'review_content')
                    
                    # ê°ì • ë¶„ì„ ê²°ê³¼ í‘œì‹œ
                    col1, col2 = st.columns(2)
                    
                    with col1:
                        # ê°ì • ë¶„í¬ íŒŒì´ ì°¨íŠ¸
                        fig = plt.figure(figsize=(6, 4))
                        sns.barplot(x=sentiment_counts['ê°ì •'], y=sentiment_counts['ë¦¬ë·° ìˆ˜'], orient='h')
                        plt.title('ë¦¬ë·° ê°ì • ë¶„í¬')
                        st.pyplot(fig)
                    
                    with col2:
                        # ê°ì •ë³„ ë¦¬ë·° ìˆ˜ ë§‰ëŒ€ ê·¸ë˜í”„
                        fig = plt.figure(figsize=(6, 4))
                        sns.barplot(x='ê°ì •', y='ë¦¬ë·° ìˆ˜', data=sentiment_counts)
                        plt.title('ê°ì •ë³„ ë¦¬ë·° ìˆ˜')
                        st.pyplot(fig)
                    
                    # ê°ì •ë³„ ë¦¬ë·° ìƒ˜í”Œ í‘œì‹œ
                    st.subheader("ê°ì •ë³„ ë¦¬ë·° ìƒ˜í”Œ")
                    
                    # íƒ­ ìƒì„±
                    tab1, tab2, tab3 = st.tabs(["ê¸ì • ë¦¬ë·°", "ì¤‘ë¦½ ë¦¬ë·°", "ë¶€ì • ë¦¬ë·°"])
                    
                    with tab1:
                        positive_reviews = df_sentiment[df_sentiment['sentiment'] == 'ê¸ì •'].head(5)
                        if not positive_reviews.empty:
                            for _, row in positive_reviews.iterrows():
                                st.write(f"- {row['review_content']}")
                        else:
                            st.write("ê¸ì • ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.")
                    
                    with tab2:
                        neutral_reviews = df_sentiment[df_sentiment['sentiment'] == 'ì¤‘ë¦½'].head(5)
                        if not neutral_reviews.empty:
                            for _, row in neutral_reviews.iterrows():
                                st.write(f"- {row['review_content']}")
                        else:
                            st.write("ì¤‘ë¦½ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.")
                    
                    with tab3:
                        negative_reviews = df_sentiment[df_sentiment['sentiment'] == 'ë¶€ì •'].head(5)
                        if not negative_reviews.empty:
                            for _, row in negative_reviews.iterrows():
                                st.write(f"- {row['review_content']}")
                        else:
                            st.write("ë¶€ì • ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.")
            
            elif analysis_option == "ì˜µì…˜ ë¶„ì„":
                st.subheader("ì˜µì…˜ ë¶„ì„")
                
                with st.spinner("ì˜µì…˜ ë¶„ì„ ì¤‘..."):
                    # ì˜µì…˜ ë¶„ì„ ìˆ˜í–‰
                    top_options = analyze_options(option_df, 'option_info', 'count')
                    
                    # ìƒìœ„ 10ê°œ ì˜µì…˜ í‘œì‹œ
                    st.subheader("ìƒìœ„ 10ê°œ ì˜µì…˜")
                    st.dataframe(top_options)
                    
                    # ìƒìœ„ 10ê°œ ì˜µì…˜ ë§‰ëŒ€ ê·¸ë˜í”„
                    fig = plt.figure(figsize=(10, 6))
                    sns.barplot(x='option_info', y='count', data=top_options)
                    plt.title('ìƒìœ„ 10ê°œ ì˜µì…˜ íŒë§¤ëŸ‰')
                    st.pyplot(fig)
        
        except Exception as e:
            st.error(f"ìƒ˜í”Œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
else:
    # ë°ì´í„° ë¡œë“œ
    try:
        # íŒŒì¼ ì—…ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
        file_extension = uploaded_file.name.split('.')[-1].lower()
        if file_extension == 'csv':
            df = pd.read_csv(uploaded_file)
        else:
            df = pd.read_excel(uploaded_file)
            
        # íŒŒì¼ ìœ í˜• ê°ì§€
        file_type = detect_file_type(df)
        
        if file_type == "review":
            review_df = check_review_columns(df)
            st.sidebar.success("ë¦¬ë·° íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.")
        elif file_type == "option":
            option_df = check_option_columns(df)
            st.sidebar.success("ì˜µì…˜ ë¹„ìœ¨ íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.")
        else:  # sales
            sales_df = df
            st.sidebar.success("íŒë§¤ í˜„í™© íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.")
        
        # íŒŒì¼ ì •ë³´ í‘œì‹œ
        st.subheader("ì—…ë¡œë“œëœ íŒŒì¼ ì •ë³´")
        st.write(f"íŒŒì¼ëª…: {uploaded_file.name}")
        st.write(f"íŒŒì¼ ìœ í˜•: {'ë¦¬ë·° ë¶„ì„ íŒŒì¼' if file_type == 'review' else 'ì˜µì…˜ ë¹„ìœ¨ íŒŒì¼' if file_type == 'option' else 'íŒë§¤ í˜„í™© íŒŒì¼'}")
        st.dataframe(df.head(3))
        
        # ë¶„ì„ ìœ í˜•ì— ë”°ë¥¸ ì²˜ë¦¬
        if analysis_option == "ë¦¬ë·° ë¶„ì„ - ì›Œë“œí´ë¼ìš°ë“œ":
            if file_type == "review":
                st.header("ë¦¬ë·° ì›Œë“œí´ë¼ìš°ë“œ ë¶„ì„")
                
                # ë¶ˆìš©ì–´ ê´€ë¦¬ UI í‘œì‹œ
                render_stopwords_ui()
                
                with st.spinner("ì›Œë“œí´ë¼ìš°ë“œ ìƒì„± ì¤‘..."):
                    word_count, top_words = generate_wordcloud_data(review_df, 'review_content')
                    
                    # ì›Œë“œí´ë¼ìš°ë“œ ìƒì„±
                    if word_count:
                        wc = create_wordcloud(word_count)
                        
                        # ì›Œë“œí´ë¼ìš°ë“œì™€ ìƒìœ„ 20ê°œ ë‹¨ì–´ë¥¼ ì¢Œìš°ë¡œ ë°°ì¹˜
                        col1, col2 = st.columns([1.5, 1])
                        
                        with col1:
                            # ì›Œë“œí´ë¼ìš°ë“œ ì œëª© ì¶”ê°€ (ì¤‘ì•™ ì •ë ¬)
                            st.markdown("<h3 style='text-align: center;'>ì›Œë“œí´ë¼ìš°ë“œ</h3>", unsafe_allow_html=True)
                            
                            # ì›Œë“œí´ë¼ìš°ë“œ í‘œì‹œ
                            fig1, ax = plt.subplots(figsize=(10, 10))
                            ax.imshow(wc, interpolation='bilinear')
                            ax.axis('off')
                            plt.tight_layout(pad=0)
                            st.pyplot(fig1)
                        
                        with col2:
                            # ìƒìœ„ 20ê°œ ë‹¨ì–´ í‘œì‹œ (ì¤‘ì•™ ì •ë ¬)
                            st.markdown("<h3 style='text-align: center;'>ìƒìœ„ 20ê°œ ë‹¨ì–´</h3>", unsafe_allow_html=True)
                            
                            # ìƒìœ„ ë‹¨ì–´ ë§‰ëŒ€ ê·¸ë˜í”„
                            top_words_df = pd.DataFrame({
                                'ë‹¨ì–´': list(top_words.keys()),
                                'ì–¸ê¸‰ íšŸìˆ˜': list(top_words.values())
                            })
                            
                            # ì •í™•íˆ ê°™ì€ í¬ê¸°ë¡œ ê·¸ë˜í”„ ìƒì„±
                            fig2, ax = plt.subplots(figsize=(10, 10))
                            bars = ax.barh(top_words_df['ë‹¨ì–´'], top_words_df['ì–¸ê¸‰ íšŸìˆ˜'], color='steelblue')
                            
                            # ë¦¬ë·° ìˆ˜ í‘œì‹œ
                            for i, bar in enumerate(bars):
                                width = bar.get_width()
                                ax.text(width + width*0.02, bar.get_y() + bar.get_height()/2, 
                                        f'{int(width):,}', 
                                        va='center', fontsize=9)
                            
                            # xì¶• ë²”ìœ„ ì¡°ì • (ì—¬ë°± ì¤„ì´ê¸°)
                            if len(top_words) > 0:
                                max_count = max(top_words.values())
                                plt.xlim(0, max_count * 1.15)  # í…ìŠ¤íŠ¸ ìœ„í•œ ì—¬ìœ  ê³µê°„
                                
                            # ê·¸ë˜í”„ ì œëª© ë° ë ˆì´ì•„ì›ƒ ì¡°ì •
                            plt.title('')
                            plt.tight_layout(pad=0.2)
                            st.pyplot(fig2)
                    else:
                        st.warning("ë¶„ì„í•  ë¦¬ë·° ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            else:
                st.warning("ë¦¬ë·° ë¶„ì„ì„ ìœ„í•´ ë¦¬ë·° íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
            
        elif analysis_option == "ë¦¬ë·° ë¶„ì„ - ê°ì •ë¶„ì„":
            if file_type == "review":
                st.header("ë¦¬ë·° ê°ì •ë¶„ì„")
                
                with st.spinner("ê°ì • ë¶„ì„ ì¤‘..."):
                    # ê°ì • ë¶„ì„ ìˆ˜í–‰
                    df_sentiment, sentiment_counts = simple_sentiment_analysis(review_df, 'review_content')
                    
                    # ê°ì • ë¶„ì„ ê²°ê³¼ í‘œì‹œ
                    col1, col2 = st.columns(2)
                    
                    with col1:
                        # ê°ì • ë¶„í¬ íŒŒì´ ì°¨íŠ¸
                        fig = plt.figure(figsize=(6, 4))
                        sns.barplot(x=sentiment_counts['ê°ì •'], y=sentiment_counts['ë¦¬ë·° ìˆ˜'], orient='h')
                        plt.title('ë¦¬ë·° ê°ì • ë¶„í¬')
                        st.pyplot(fig)
                    
                    with col2:
                        # ê°ì •ë³„ ë¦¬ë·° ìˆ˜ ë§‰ëŒ€ ê·¸ë˜í”„
                        fig = plt.figure(figsize=(6, 4))
                        sns.barplot(x='ê°ì •', y='ë¦¬ë·° ìˆ˜', data=sentiment_counts)
                        plt.title('ê°ì •ë³„ ë¦¬ë·° ìˆ˜')
                        st.pyplot(fig)
                    
                    # ê°ì •ë³„ ë¦¬ë·° ìƒ˜í”Œ í‘œì‹œ
                    st.subheader("ê°ì •ë³„ ë¦¬ë·° ìƒ˜í”Œ")
                    
                    # íƒ­ ìƒì„±
                    tab1, tab2, tab3 = st.tabs(["ê¸ì • ë¦¬ë·°", "ì¤‘ë¦½ ë¦¬ë·°", "ë¶€ì • ë¦¬ë·°"])
                    
                    with tab1:
                        positive_reviews = df_sentiment[df_sentiment['sentiment'] == 'ê¸ì •'].head(5)
                        if not positive_reviews.empty:
                            for _, row in positive_reviews.iterrows():
                                st.write(f"- {row['review_content']}")
                        else:
                            st.write("ê¸ì • ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.")
                    
                    with tab2:
                        neutral_reviews = df_sentiment[df_sentiment['sentiment'] == 'ì¤‘ë¦½'].head(5)
                        if not neutral_reviews.empty:
                            for _, row in neutral_reviews.iterrows():
                                st.write(f"- {row['review_content']}")
                        else:
                            st.write("ì¤‘ë¦½ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.")
                    
                    with tab3:
                        negative_reviews = df_sentiment[df_sentiment['sentiment'] == 'ë¶€ì •'].head(5)
                        if not negative_reviews.empty:
                            for _, row in negative_reviews.iterrows():
                                st.write(f"- {row['review_content']}")
                        else:
                            st.write("ë¶€ì • ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.")
            else:
                st.warning("ë¦¬ë·° ë¶„ì„ì„ ìœ„í•´ ë¦¬ë·° íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
            
        elif analysis_option == "ì˜µì…˜ ë¶„ì„":
            if file_type == "option":
                st.header("ì˜µì…˜ ë¶„ì„")
                
                with st.spinner("ì˜µì…˜ ë¶„ì„ ì¤‘..."):
                    # ì˜µì…˜ ë¶„ì„ ìˆ˜í–‰
                    top_options = analyze_options(option_df, 'option_info', 'count')
                    
                    # ìƒìœ„ 10ê°œ ì˜µì…˜ í‘œì‹œ
                    st.subheader("ìƒìœ„ 10ê°œ ì˜µì…˜")
                    st.dataframe(top_options)
                    
                    # ìƒìœ„ 10ê°œ ì˜µì…˜ ë§‰ëŒ€ ê·¸ë˜í”„
                    fig = plt.figure(figsize=(10, 6))
                    sns.barplot(x='option_info', y='count', data=top_options)
                    plt.title('ìƒìœ„ 10ê°œ ì˜µì…˜ íŒë§¤ëŸ‰')
                    st.pyplot(fig)
            else:
                st.warning("ì˜µì…˜ ë¶„ì„ì„ ìœ„í•´ ì˜µì…˜ ë¹„ìœ¨ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
            
    except Exception as e:
        st.error(f"ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}") 